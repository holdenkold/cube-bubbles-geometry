<!DOCTYPE html>
<html lang="en">

<head>
    <title>three.js webgl - effects - anaglyph</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/102/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
    <script src="lib.js"></script>
    <title>Cube with bubbles</title>
</head>

<body>
    <script>
        function main() {
            const gui = new dat.GUI();
            var focus = 'group';
            var container, camera, scene, renderer, group, cam_focus;
            var spheres = [];
            var spotLights = [];
            var cubesize = 10.6;

            var mouseX = 0;
            var mouseY = 0;

            var sphere_number = 1;

            var light, ambient, spotLight;

            var meshBox;

            var windowHalfX = window.innerWidth / 2;
            var windowHalfY = window.innerHeight / 2;

            var xSpeed = 5;
            var ySpeed = 5;

            document.addEventListener("keydown", onDocumentKeyDown, false);
            window.addEventListener('resize', onWindowResize, false);
            // document.addEventListener( 'mousemove', onDocumentMouseMove, false );

            init();
            //dispaygui();
            animate();

            function init() {
                container = document.createElement('div');
                document.body.appendChild(container);

                //CAMERA
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 1000);
                camera.position.z = 30;

                scene = new THREE.Scene();

                {
                    const near = 0.015;
                    const far = 50;
                    const color = 0x894c4c;
                    //scene.fog = new THREE.Fog(color, 0.015, 50);
                    scene.background = new THREE.Color(color);

                    //const fogGUIHelper = new FogGUIHelper(scene.fog, scene.background);
                    //var fog = gui.addFolder('Fog');
                    // fog.add(fogGUIHelper, 'near', near, far).listen();
                    // fog.add(fogGUIHelper, 'far', near, far).listen();
                    //fog.addColor(fogGUIHelper, 'color');
                }
       

                // SHAPES
                group = new THREE.Group();

                // SPHERES
                var geometry = new THREE.SphereGeometry(0.1, 32, 16);
                var material = new THREE.MeshLambertMaterial({ color: 0x738191 });
                for (var i = 0; i < sphere_number; i++) {
                    var mesh = new THREE.Mesh(geometry, material);

                    mesh.position.x = Math.random() * 10 - 5;
                    mesh.position.y = Math.random() * 10 - 5;
                    mesh.position.z = Math.random() * 10 - 5;

                    mesh.scale.x = mesh.scale.y = mesh.scale.z = Math.random() * 3 + 1;

                    var spotLight = createSpotlight(mesh.position.x, mesh.position.y, mesh.position.z, 0xaf00b9);
                    group.add(spotLight);
                    spotLights.push(spotLight);
                    lightHelper = new THREE.SpotLightHelper( spotLight );
				    scene.add( lightHelper );

                    group.add(mesh);
                    spheres.push(mesh);
                }

                //CUBE
                var geometryBox = new THREE.BoxGeometry(cubesize, cubesize, cubesize);
                var materialBox = new THREE.MeshPhongMaterial({ color: 0xc3dbf7, opacity: 0.5, transparent: true });
                meshBox = new THREE.Mesh(geometryBox, materialBox);
                meshBox.name = 'cube';
                group.add(meshBox);
                group.position.y += 8;
                scene.add(group);

                //LIGHT
                light = new THREE.PointLight(0xFFFFFF, 1, 500);
                light.position.set(10, 0, 25);
                scene.add(light);

                ambient = new THREE.AmbientLight(0xffffff, 0.1);
                scene.add(ambient);

                //var spotLight1 = createSpotlight(0xFF7F00);
                // var spotLight2 = createSpotlight(0x00FF7F);
                // var spotLight3 = createSpotlight(0x7F00FF);

                // scene.add(spotLight1);
                // scene.add(spotLight2);
                // scene.add(spotLight3);

                // light = new THREE.HemisphereLight( 0xFFFFFF, 0x080820, 0.7 );
                // light = new THREE.PointLight(0xFFFFFF, 1, 200); //noc dzieÅ„ zmiany
                // light.position.set(10, 0, 25);
                // scene.add(light);


                //RENDERER
                renderer = new THREE.WebGLRenderer();
                //renderer.setClearColor(0xb6d5db, 1.0);
                renderer.setSize(window.innerWidth, window.innerHeight);

                //renderer.setPixelRatio( window.devicePixelRatio ); //?
                container.appendChild(renderer.domElement);
                window.addEventListener('resize', onWindowResize, false);

                var options = {
                    fog: false,
                    dayTime: ambient.intensity,
                    night: false,
                    camera: {
                        type: ""
                    },
                    shading: {
                        type: ""
                    }

                };



                var cam = gui.addFolder('Camera');
                cam.add(options.camera, 'type', ["Scene", "moving object (stationary)", "moving object (moving)"]).name("Type").onChange(function (val) {
                    if (focus == 'group') {
                        focus = 'scene';
                    }
                    else
                    {
                        focus = 'group';
                    }
                });
                cam.open();

                var shad = gui.addFolder('Shading');
                shad.add(options.shading, 'type', ["Constant shading", "Gouraud shading", "Phong shading"]).name("Type");
                shad.open();

                gui.add(options, 'dayTime', 0.0, 0.6).step(0.01).onChange(function (val) {
                    ambient.intensity = val;
                    light.intensity = val + 0.1;
                });



            }

            // function update_camera(camera, cube, scene) {
            //     if (cube && scene) {
            //         if (cam_focus == "Scene")
            //             update_scene_camera(camera, scene);
            //         else
            //             update_static_camera(camera, cube);
            //     }
            // }

            function animate() {
                requestAnimationFrame(animate);
                render();
            }

            // EVENTS:
            function onWindowResize() {
                windowHalfX = window.innerWidth / 2;
                windowHalfY = window.innerHeight / 2;

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function onDocumentMouseMove(event) {
                mouseX = (event.clientX - windowHalfX) / 100;
                mouseY = (event.clientY - windowHalfY) / 100;
            }

            // This function uses mac os key codes, may not work on other platdforms.
            function onDocumentKeyDown(event) {
                var keyCode = event.code;
                if (keyCode == 'ArrowUp') {
                    group.position.y += ySpeed;
                } else if (keyCode == 'ArrowDown') {
                    group.position.y -= ySpeed;
                } else if (keyCode == 'ArrowLeft') {
                    group.position.x -= xSpeed;
                } else if (keyCode == 'ArrowRight') {
                    group.position.x += xSpeed;
                } else if (keyCode == 'Enter') {
                    group.position.set(-5, -5, -5);
                }
            };

            function createSpotlight(color) {
                var newObj = new THREE.SpotLight(color, 2);

                newObj.position.set(15, 40, 35);
                newObj.angle = Math.PI / 4;
                newObj.penumbra = 0.05;
                newObj.decay = 2;
                newObj.distance = 100;

                //newObj.castShadow = true;
                // newObj.penumbra = 0.2;
                // newObj.decay = 2;
                // newObj.distance = 30;

                return newObj;
            }

            function render() {
                var timer = 0.0001 * Date.now();

                camera.position.x += (mouseX - camera.position.x) * .05;
                camera.position.y += (- mouseY - camera.position.y) * .05;

                //camera.lookAt(group.position);
                if (focus == 'group') {
                    camera.lookAt(group.position);
                }
                else {
                    camera.lookAt(scene.position);
                }

                for (var i = 0, il = spheres.length; i < il; i++) {

                    var sphere = spheres[i];

                    sphere.position.x = 5 * Math.cos(timer + i);
                    sphere.position.y = 5 * Math.sin(timer + i * 1.1);

                    var spotLight = spotLights[i]
                    spotLight.position.x = sphere.position.x;
                    spotLight.position.y = sphere.position.y;

                }

                group.rotation.x += 0.001;
                group.rotation.y += 0.001;
                group.rotation.z += 0.001;

                renderer.render(scene, camera);
            }
        }

        main()
    </script>
</body>

</html>